#!/usr/bin/env ruby2.0

load 'lib/proxy.rb'

require 'fileutils'

cache  = Proxy::Cache.new
config = Proxy::NginxConfig.new(
  [
    ["foo", "https://www.google.com"],
    ["bar", "https://codewords.recurse.com"],
    ["baz", "https://github.com"],
    ["hmm", "https://example.com"]
  ]
)

SYMLINK_LOCATION = "/etc/nginx/sites-available/default"

if loc = cache.store(config)
  puts "Wrote to cache: #{loc}"
end

path = cache.path(config)

unless File.readlink(SYMLINK_LOCATION) == path
  puts "Linking new nginx conf: #{path}"
  FileUtils.ln_sf(path, SYMLINK_LOCATION)

  system("service nginx reload")
end
