#!/usr/bin/env ruby2.0

require_relative '../lib/proxy'

require 'optparse'
require 'fileutils'

Proxy.configure do |config|
  OptionParser.new do |opts|
    opts.banner = "Usage: proxy [options]"

    opts.on("-p", "--production", "Run in production") do |p|
      config.env = p ? "production" : "development"
    end
  end.parse!
end

cache  = Proxy::Cache.new
config = Proxy::NginxConfig.new(
  [
    ["bar", "https://www.google.com"],
    ["foo", "https://codewords.recurse.com"],
    ["baz", "https://github.com"],
    ["hmm", "https://github.com"]
  ]
)

SYMLINK_LOCATION = "/etc/nginx/sites-available/default"

if cache.store(config)
  Proxy.logger.info "Wrote new conf to cache"
end

path = cache.path(config)
current = File.readlink(SYMLINK_LOCATION)

unless current == path
  Proxy.logger.info "Linking new nginx conf: #{path}"
  FileUtils.ln_sf(path, SYMLINK_LOCATION)

  if system("nginx -t && service nginx reload")
    Proxy.logger.info "nginx reloaded"
  else
    Proxy.logger.error "nginx reload failed, relinking old conf and reloading: #{current}"
    FileUtils.ln_sf(current, SYMLINK_LOCATION)
    system("service nginx reload")
  end
end
